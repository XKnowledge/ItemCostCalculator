<!DOCTYPE html>

<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>物品成本计算器</title>
    <!-- Tailwind CSS -->
    <script src="https://image.uc.cn/s/uae/g/3n/mos-production/0915/3.4.17.js"></script>
    <!-- Font Awesome -->
    <script src="https://image.uc.cn/s/uae/g/3n/mos-production/fontawesome-free-7.1.0-web/js/all.min.js"></script>
    <link href="https://image.uc.cn/s/uae/g/3n/mos-production/fontawesome-free-7.1.0-web/css/fontawesome.min.css"
        rel="stylesheet" />
    <style>
        /* Custom styles for transitions and specific UI elements */
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f3f4f6;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50;
        }

        .toast {
            background: white;
            border-left: 4px solid;
            padding: 16px 24px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            border-color: #10b981;
        }

        .toast.error {
            border-color: #ef4444;
        }

        .toast.info {
            border-color: #3b82f6;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        ::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        * {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }
    </style>
</head>

<body class="text-gray-800 h-screen flex flex-col overflow-hidden">
    <!-- Header (draggable area for frameless window) -->
    <header class="bg-white shadow-sm z-10 flex-shrink-0" style="-webkit-app-region: drag;">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-calculator text-indigo-600 text-2xl"></i>
                <h1 class="text-xl font-bold text-gray-900">物品成本计算器</h1>
            </div>
            <div class="flex items-center gap-1" style="-webkit-app-region: no-drag;">
                <button onclick="window.electronAPI.minimizeWindow()" class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 rounded-lg transition" title="最小化">
                    <i class="fa-solid fa-minus text-gray-600"></i>
                </button>
                <button onclick="window.electronAPI.maximizeWindow()" class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 rounded-lg transition" title="最大化">
                    <i class="fa-regular fa-square text-gray-600"></i>
                </button>
                <button onclick="window.electronAPI.closeWindow()" class="w-10 h-10 flex items-center justify-center hover:bg-red-500 hover:text-white rounded-lg transition text-gray-600" title="关闭">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>
    </header>
    <!-- Main Content -->
    <main class="flex-1 overflow-hidden max-w-7xl w-full mx-auto p-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
            <!-- Left Column: Add Item Form -->
            <section class="lg:col-span-4 flex flex-col gap-6 overflow-y-auto pr-2 pb-10">
                <div class="bg-white rounded-xl shadow-md p-6 border border-gray-100">
                    <h2 class="text-lg font-semibold mb-4 text-gray-800 flex items-center gap-2">
                        <i class="fa-solid fa-plus-circle text-indigo-500"></i> 添加新物品
                    </h2>
                    <form class="space-y-4" id="addItemForm">
                        <!-- Item Name -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" for="itemName">物品名称</label>
                            <input
                                class="w-full rounded-lg border-gray-300 border px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                                id="itemName" placeholder="例如：机械键盘" required="" type="text" />
                        </div>
                        <!-- Purchase Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" for="purchaseDate">购买时间</label>
                            <input
                                class="w-full rounded-lg border-gray-300 border px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                                id="purchaseDate" required="" type="date" />
                        </div>
                        <!-- Purchase Price -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" for="purchasePrice">购买金额
                                (元)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500">¥</span>
                                <input
                                    class="w-full rounded-lg border-gray-300 border pl-8 pr-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                                    id="purchasePrice" min="0.01" placeholder="0.00" required="" step="0.01"
                                    type="number" />
                            </div>
                        </div>
                        <!-- Calculation Type -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">计算类型</label>
                            <div class="flex gap-4">
                                <label
                                    class="flex items-center gap-2 cursor-pointer p-2 border rounded-lg hover:bg-gray-50 flex-1 transition">
                                    <input checked="" class="text-indigo-600 focus:ring-indigo-500" name="calcType"
                                        type="radio" value="time" />
                                    <span class="text-sm">按时间</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 cursor-pointer p-2 border rounded-lg hover:bg-gray-50 flex-1 transition">
                                    <input class="text-indigo-600 focus:ring-indigo-500" name="calcType" type="radio"
                                        value="usage" />
                                    <span class="text-sm">按次数</span>
                                </label>
                            </div>
                        </div>
                        <!-- Usage Count (Conditional) -->
                        <div class="hidden transition-all duration-300" id="usageCountContainer">
                            <label class="block text-sm font-medium text-gray-700 mb-1" for="usageCount">使用次数</label>
                            <input
                                class="w-full rounded-lg border-gray-300 border px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                                id="usageCount" min="1" placeholder="例如：10" type="number" />
                        </div>
                        <!-- Stop Date (Optional) -->
                        <div id="stopDateContainer">
                            <label class="block text-sm font-medium text-gray-700 mb-1" for="stopDate">停止使用时间（可选）</label>
                            <input
                                class="w-full rounded-lg border-gray-300 border px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                                id="stopDate" type="date" />
                            <p class="text-xs text-gray-500 mt-1">留空则按当前日期计算使用成本</p>
                        </div>
                        <!-- Submit Button -->
                        <button
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 rounded-lg shadow-md transition duration-200 flex justify-center items-center gap-2"
                            type="submit">
                            <i class="fa-solid fa-check"></i> 添加物品
                        </button>
                    </form>
                </div>
                <!-- Summary Card (Optional Enhancement) -->
                <div class="bg-indigo-50 rounded-xl p-6 border border-indigo-100">
                    <h3 class="text-indigo-800 font-semibold mb-2">使用说明</h3>
                    <ul class="text-sm text-indigo-700 space-y-1 list-disc list-inside">
                        <li id="dateHint">按时间计算：基于当前日期 (<span id="currentDateDisplay"></span>) 或停止使用时间计算日均成本。</li>
                        <li>按次数计算：基于输入的使用次数计算单次成本。</li>
                        <li>数据自动保存在浏览器中，刷新不会丢失。</li>
                    </ul>
                </div>
            </section>
            <!-- Right Column: Item List -->
            <section
                class="lg:col-span-8 flex flex-col h-full overflow-hidden bg-white rounded-xl shadow-md border border-gray-100">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i class="fa-solid fa-list-ul text-indigo-500"></i> 物品列表
                    </h2>
                    <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-full"
                        id="itemCountBadge">0 个物品</span>
                </div>
                <div class="flex-1 overflow-y-auto p-0">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">物品信息
                                </th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">成本详情
                                </th>
                                <th
                                    class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">
                                    操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100" id="itemsTableBody">
                            <!-- Items will be injected here via JS -->
                        </tbody>
                    </table>
                    <!-- Empty State -->
                    <div class="hidden flex flex-col items-center justify-center h-64 text-gray-400" id="emptyState">
                        <i class="fa-solid fa-box-open text-5xl mb-4 text-gray-300"></i>
                        <p class="text-lg">暂无物品数据</p>
                        <p class="text-sm">请在左侧添加您的第一个物品</p>
                    </div>
                </div>
            </section>
        </div>
    </main>
    <!-- Edit Modal -->
    <div class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center" id="editModal">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition-all scale-100 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">修改使用次数</h3>
            <p class="text-sm text-gray-500 mb-4" id="editItemNameDisplay"></p>
            <form id="editForm">
                <input id="editItemId" type="hidden" />
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="editUsageCount">新的使用次数</label>
                    <input
                        class="w-full rounded-lg border-gray-300 border px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                        id="editUsageCount" min="1" required="" type="number" />
                </div>
                <div class="flex justify-end gap-3">
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition"
                        onclick="closeModal()" type="button">取消</button>
                    <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
                        type="submit">保存修改</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Stop Date Modal -->
    <div class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center" id="stopDateModal">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition-all scale-100 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">设置停止使用时间</h3>
            <p class="text-sm text-gray-500 mb-4" id="stopDateItemNameDisplay"></p>
            <form id="stopDateForm">
                <input id="stopDateItemId" type="hidden" />
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="editStopDate">停止使用时间</label>
                    <input
                        class="w-full rounded-lg border-gray-300 border px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                        id="editStopDate" type="date" />
                    <p class="text-xs text-gray-500 mt-1">留空表示仍在使用中</p>
                </div>
                <div class="flex justify-end gap-3">
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition"
                        onclick="closeStopDateModal()" type="button">取消</button>
                    <button class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition"
                        type="submit">保存修改</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Toast Container -->
    <div id="toast-container"></div>
    <script>
        /**
         * Configuration & State
         */
        const CURRENT_DATE = new Date(); // Current date
        let items = [];

        // DOM Elements
        const form = document.getElementById('addItemForm');
        const tableBody = document.getElementById('itemsTableBody');
        const emptyState = document.getElementById('emptyState');
        const itemCountBadge = document.getElementById('itemCountBadge');
        const usageCountContainer = document.getElementById('usageCountContainer');
        const calcTypeRadios = document.getElementsByName('calcType');

        // Modal Elements
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const editItemIdInput = document.getElementById('editItemId');
        const editUsageCountInput = document.getElementById('editUsageCount');
        const editItemNameDisplay = document.getElementById('editItemNameDisplay');

        /**
         * Initialization
         */
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            renderList();
            setupEventListeners();
            // Update current date display
            const dateDisplay = document.getElementById('currentDateDisplay');
            if (dateDisplay) {
                dateDisplay.textContent = CURRENT_DATE.toISOString().split('T')[0];
            }
        });

        /**
         * Event Listeners Setup
         */
        function setupEventListeners() {
            // Toggle Usage Count Input based on Calculation Type
            calcTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'usage') {
                        usageCountContainer.classList.remove('hidden');
                        document.getElementById('usageCount').setAttribute('required', 'true');
                        // 按次数计算时，隐藏停止使用时间
                        document.getElementById('stopDateContainer').classList.add('hidden');
                    } else {
                        usageCountContainer.classList.add('hidden');
                        document.getElementById('usageCount').removeAttribute('required');
                        // 按时间计算时，显示停止使用时间
                        document.getElementById('stopDateContainer').classList.remove('hidden');
                    }
                });
            });

            // Add Item Form Submit
            form.addEventListener('submit', handleAddItem);

            // Edit Form Submit
            editForm.addEventListener('submit', handleSaveEdit);
        }

        /**
         * Core Logic: Data Management
         */
        async function loadData() {
            try {
                items = await window.electronAPI.getItems();
            } catch (e) {
                console.error('Failed to load data', e);
                items = [];
            }
        }

        async function handleAddItem(e) {
            e.preventDefault();

            const name = document.getElementById('itemName').value.trim();
            const date = document.getElementById('purchaseDate').value;
            const price = parseFloat(document.getElementById('purchasePrice').value);
            const type = document.querySelector('input[name="calcType"]:checked').value;

            let usageCount = null;
            if (type === 'usage') {
                usageCount = parseInt(document.getElementById('usageCount').value);
                if (!usageCount || usageCount <= 0) {
                    showToast('使用次数必须大于0', 'error');
                    return;
                }
            }

            // Get stop date (optional, only for time-based calculation)
            const stopDate = type === 'time' ? (document.getElementById('stopDate').value || null) : null;

            const newItem = {
                id: Date.now().toString(), // Simple unique ID
                name: name,
                purchaseDate: date,
                price: price,
                type: type,
                usageCount: usageCount,
                stopDate: stopDate
            };

            try {
                await window.electronAPI.saveItem(newItem);
                items.push(newItem);
                renderList();
                form.reset();

                // Reset UI state for calculation type
                usageCountContainer.classList.add('hidden');
                document.getElementById('stopDateContainer').classList.remove('hidden');
                document.querySelector('input[name="calcType"][value="time"]').checked = true;

                showToast('物品添加成功', 'success');
            } catch (e) {
                console.error('Failed to save item', e);
                showToast('保存失败', 'error');
            }
        }

        async function deleteItem(id) {
            try {
                await window.electronAPI.deleteItem(id);
                items = items.filter(item => item.id !== id);
                renderList();
                showToast('物品已删除', 'info');
            } catch (e) {
                console.error('Failed to delete item', e);
                showToast('删除失败', 'error');
            }
        }

        function openEditModal(id) {
            const item = items.find(i => i.id === id);
            if (!item || item.type !== 'usage') return;

            editItemIdInput.value = item.id;
            editUsageCountInput.value = item.usageCount;
            editItemNameDisplay.textContent = `正在修改 "${item.name}" 的使用次数`;

            editModal.classList.remove('hidden');
        }

        function closeModal() {
            editModal.classList.add('hidden');
        }

        // Stop Date Modal Functions
        const stopDateModal = document.getElementById('stopDateModal');
        const stopDateForm = document.getElementById('stopDateForm');
        const stopDateItemIdInput = document.getElementById('stopDateItemId');
        const editStopDateInput = document.getElementById('editStopDate');
        const stopDateItemNameDisplay = document.getElementById('stopDateItemNameDisplay');

        function openStopDateModal(id) {
            const item = items.find(i => i.id === id);
            if (!item || item.type !== 'time') return;

            stopDateItemIdInput.value = item.id;
            editStopDateInput.value = item.stopDate || '';
            stopDateItemNameDisplay.textContent = `正在修改 "${item.name}" 的停止使用时间`;

            stopDateModal.classList.remove('hidden');
        }

        function closeStopDateModal() {
            stopDateModal.classList.add('hidden');
        }

        async function handleSaveStopDate(e) {
            e.preventDefault();
            const id = stopDateItemIdInput.value;
            const newStopDate = editStopDateInput.value || null;

            const itemIndex = items.findIndex(i => i.id === id);
            if (itemIndex !== -1) {
                items[itemIndex].stopDate = newStopDate;
                try {
                    await window.electronAPI.updateItem(items[itemIndex]);
                    renderList();
                    closeStopDateModal();
                    showToast('停止时间已更新', 'success');
                } catch (e) {
                    console.error('Failed to update item', e);
                    showToast('更新失败', 'error');
                }
            }
        }

        stopDateForm.addEventListener('submit', handleSaveStopDate);

        async function handleSaveEdit(e) {
            e.preventDefault();
            const id = editItemIdInput.value;
            const newCount = parseInt(editUsageCountInput.value);

            if (newCount <= 0) {
                showToast('使用次数必须大于0', 'error');
                return;
            }

            const itemIndex = items.findIndex(i => i.id === id);
            if (itemIndex !== -1) {
                items[itemIndex].usageCount = newCount;
                try {
                    await window.electronAPI.updateItem(items[itemIndex]);
                    renderList();
                    closeModal();
                    showToast('使用次数已更新', 'success');
                } catch (e) {
                    console.error('Failed to update item', e);
                    showToast('更新失败', 'error');
                }
            }
        }

        /**
         * Core Logic: Calculation & Rendering
         */
        function renderList() {
            tableBody.innerHTML = '';

            if (items.length === 0) {
                emptyState.classList.remove('hidden');
                itemCountBadge.textContent = '0 个物品';
                return;
            }

            emptyState.classList.add('hidden');
            itemCountBadge.textContent = `${items.length} 个物品`;

            // Sort items: Newest first
            const sortedItems = [...items].sort((a, b) => new Date(b.purchaseDate) - new Date(a.purchaseDate));

            sortedItems.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition fade-in';

                // Common formatting
                const formattedPrice = formatCurrency(item.price);
                const formattedDate = item.purchaseDate;

                let detailsHtml = '';
                let actionButtons = '';

                if (item.type === 'time') {
                    // Time based calculation
                    const days = calculateDaysDiff(item.purchaseDate, item.stopDate);
                    const dailyCost = days > 0 ? item.price / days : 0;
                    const stopDateText = item.stopDate ? item.stopDate : '使用中';
                    const stopDateDisplay = item.stopDate
                        ? `<span class="text-orange-600">${item.stopDate}</span>`
                        : `<span class="text-green-600">使用中</span>`;

                    detailsHtml = `
                        <div class="text-sm text-gray-900 font-medium">已使用 <span class="text-indigo-600 font-bold">${days}</span> 天</div>
                        <div class="text-xs text-gray-500">停止时间: <span class="text-gray-900 font-semibold">${stopDateDisplay}</span></div>
                        <div class="text-xs text-gray-500">日均成本: <span class="text-gray-900 font-semibold">${formatCurrency(dailyCost)}</span></div>
                    `;
                    actionButtons = `
                        <button onclick="openStopDateModal('${item.id}')" class="text-orange-500 hover:text-orange-700 hover:bg-orange-50 p-2 rounded-lg transition mr-1" title="设置停止时间">
                            <i class="fa-solid fa-calendar-xmark"></i>
                        </button>
                        <button onclick="deleteItem('${item.id}')" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition" title="删除">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    `;
                } else {
                    // Usage based calculation
                    const costPerUse = item.usageCount > 0 ? item.price / item.usageCount : 0;

                    detailsHtml = `
                        <div class="text-sm text-gray-900 font-medium">使用 <span class="text-indigo-600 font-bold">${item.usageCount}</span> 次</div>
                        <div class="text-xs text-gray-500">单次成本: <span class="text-gray-900 font-semibold">${formatCurrency(costPerUse)}</span></div>
                    `;
                    actionButtons = `
                        <button onclick="openEditModal('${item.id}')" class="text-indigo-500 hover:text-indigo-700 hover:bg-indigo-50 p-2 rounded-lg transition mr-1" title="修改次数">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        <button onclick="deleteItem('${item.id}')" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition" title="删除">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    `;
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600">
                                <i class="fa-solid ${item.type === 'time' ? 'fa-clock' : 'fa-rotate'}"></i>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-bold text-gray-900">${escapeHtml(item.name)}</div>
                                <div class="text-xs text-gray-500">购买于 ${formattedDate}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900 mb-1">${formattedPrice}</div>
                        ${detailsHtml}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex justify-end">
                            ${actionButtons}
                        </div>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        function calculateDaysDiff(purchaseDateStr, stopDateStr = null) {
            const purchaseDate = new Date(purchaseDateStr);
            // Set time to midnight to avoid partial day issues
            purchaseDate.setHours(0, 0, 0, 0);

            // Use stop date if provided, otherwise use current date
            const targetDate = stopDateStr ? new Date(stopDateStr) : new Date(CURRENT_DATE);
            targetDate.setHours(0, 0, 0, 0);

            const diffTime = targetDate - purchaseDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return diffDays > 0 ? diffDays : 0;
        }

        /**
         * Utilities
         */
        function formatCurrency(num) {
            return new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(num);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function (m) { return map[m]; });
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            let icon = '';
            if (type === 'success') icon = '<i class="fa-solid fa-circle-check text-green-500 mr-3 text-lg"></i>';
            else if (type === 'error') icon = '<i class="fa-solid fa-circle-exclamation text-red-500 mr-3 text-lg"></i>';
            else icon = '<i class="fa-solid fa-circle-info text-blue-500 mr-3 text-lg"></i>';

            toast.className = `toast ${type}`;
            toast.innerHTML = `
                ${icon}
                <div class="text-sm font-medium text-gray-800">${message}</div>
            `;

            container.appendChild(toast);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-in';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            if (event.target == editModal) {
                closeModal();
            }
            if (event.target == stopDateModal) {
                closeStopDateModal();
            }
        }
    </script>
</body>

</html>